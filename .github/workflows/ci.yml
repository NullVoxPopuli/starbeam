name: CI
on:
  push:
    branches: [master]
  pull_request:

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  preflight:
    name: "Setup"
    runs-on: "ubuntu-latest"
    outputs:
      workspaces: ${{ steps.find-workspaces.outputs.workspaces }}

    steps:
      - uses: actions/checkout@v2
      - name: "Setup node and install dependencies"
        uses: ./.github/actions/setup-node-and-install
        # currently not used - as tests, lints, etc are all top-level commands / projects
        # if we were to make each workspace isolated, we'd first need to copy tsc/eslint/vitest
        # configs into each package -- but that would be slower than what today's setup is.
      - id: find-workspaces
        name: "Find workspaces"
        #
        # json looks like:
        #
        # [
        #   {
        #      "name": "@starbeam/cocre"
        #      "version": "...",
        #      "path": "/absolute path from root of drive",
        #      "private": false,
        #   }
        #   ...
        # ]
        #
        # the sed command changes the absolute path to a relative path
        run: |
          root_of_repo=$(git rev-parse --show-toplevel)
          workspaces=$( \
            pnpm ls -r --depth -1 --json \
            | sed "s~$root_of_repo~.~g" \
          )
          echo "::set-output name=workspaces::$()"
  temp:
    name: "temp"
    runs-on: "ubuntu-latest"
    needs: ['preflight']
    steps:
      - name: 'Show workspaces'
        run: echo " ${{ fromJson( needs.preflight.outputs.workspaces )}} "

  test:
    name: "Tests"
    runs-on: "ubuntu-latest"
    needs: ['preflight']
    steps:
      - uses: actions/checkout@v2
      - name: "Setup node and install dependencies"
        uses: ./.github/actions/setup-node-and-install
      - run: pnpm test

  typecheck:
    name: "Typecheck"
    runs-on: "ubuntu-latest"
    needs: ['preflight']
    strategy:
      fail-fast: true
      matrix: ${{ fromJson(needs.preflight.outputs.workspaces) }}

    steps:
      - uses: actions/checkout@v2
      - name: "Setup node and install dependencies"
        uses: ./.github/actions/setup-node-and-install
      - name: "Check types"
        run: pnpm tsc --build
        working-directory: ${{matrix.path}}

  lint:
    name: "Lint"
    runs-on: "ubuntu-latest"
    needs: ['preflight']
    steps:
      - uses: actions/checkout@v2
      - name: "Setup node and install dependencies"
        uses: ./.github/actions/setup-node-and-install
      - run: pnpm lint


  release:
    name: Release
    runs-on: ubuntu-latest
    needs: ['lint', 'typecheck', 'test']
    steps:
      - uses: actions/checkout@v2
      - name: "Setup node and install dependencies"
        uses: ./.github/actions/setup-node-and-install

      - name: Create Release Pull Request or Publish to npm
        id: changesets
        uses: changesets/action@v1
        # with:
        #   publish: pnpm release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
